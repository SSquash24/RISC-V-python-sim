import pytest
from modules.RV32I import RV32I
from riscv import RISCV # used for clean_instr() command

tests = [
    #OP
    ('add x12, x1, x3', '00000000001100001000011000110011'),
    ('sub x0, x1, x20', '01000001010000001000000000110011'),
    ('xor x31, x29, x0', '00000000000011101100111110110011'),
    ('or x11, x15, x10', '00000000101001111110010110110011'),
    ('and x2, x28, x16', '00000001000011100111000100110011'),
    ('sll x3, x4, x7', '00000000011100100001000110110011'),
    ('srl x8, x6, x1', '00000000000100110101010000110011'),
    ('sra x22, x27, x11', '01000000101111011101101100110011'),
    ('slt x8, x18, x28', '00000001110010010010010000110011'),
    ('sltu x31, x1, x30', '00000001111000001011111110110011'),
    #IMM-OP
    ('addi, x2, x8, 2047', '01111111111101000000000100010011'),
    ('xori x3, x30, -2048', '10000000000011110100000110010011'),
    ('ori x1, x11, 7', '00000000011101011110000010010011'),
    ('andi x28, x9, -2', '11111111111001001111111000010011'),
    ('slli x5, x15, 12', '00000000110001111001001010010011'),
    ('srli x24, x22, 7', '00000000011110110101110000010011'),
    ('srai x29, x20, 21', '01000001010110100101111010010011'),
    ('slti x9, x17, -18', '11111110111010001010010010010011'),
    ('sltiu x12, x26, 31', '00000001111111010011011000010011'),
    #LOAD
    ('lb x1, x2, -7', '11111111100100010000000010000011'),
    ('lh x9, x0, 208', '00001101000000000001010010000011'),
    ('lw x19, x30, 2044', '01111111110011110010100110000011'),
    ('lbu x3, x0, 18', '00000001001000000100000110000011'),
    ('lhu x21, x22, -1092', '10111011110010110101101010000011'),
    #STORE
    ('sb x9, x12, 48', '00000010110001001000100000100011'),
    ('sh x17, x22, -252', '11110001011010001001001000100011'),
    ('sw x19, x28, -996', '11000001110010011010111000100011'),
    #BRANCH
    ('beq x1, x7, 8', '00000000011100001000010001100011'),
    ('bne x8, x11, -12', '11111110101101000001101011100011'),
    ('blt x21, x12, 8', '00000000110010101100010001100011'),
    ('bge x7, x31, 2044', '01111111111100111101111001100011'),
    ('bltu x1, x2, 138', '00001000001000001110010101100011'),
    ('bgeu x8, x17, -1112', '10111011000101000111010011100011'),
    #JUMP
    ('jal x2, 99986', '01101001001000011000000101101111'),
    ('jalr x9, x4, -224', '11110010000000100000010011100111'),
    #LOAD UPPER
    ('lui x9, 98765', '00011000000111001101010010110111'),
    ('auipc x13, -9999', '11111101100011110001011010010111'),
    #SYSTEM
    ('ecall', '00000000000000000000000001110011'),
    ('ebreak', '00000000000100000000000001110011')
]

class TestAssembler:

    sim = RV32I({'mem_size': 16, 'modules':[RV32I.__name__], 'pc': 0, 'mem': [], 'debug': True, 'status': 'RUNNING'})

    @pytest.mark.parametrize('instr, binary', tests)

    def test_assemble(self, instr, binary):
        success, bits = self.sim.assemble(*RISCV.clean_instr(instr))
        assert success
        assert bits == binary

    @pytest.mark.parametrize('instr, binary', tests)

    def test_unassemble(self, instr, binary):
        success, packed = self.sim.unassemble(binary)
        assert success
        instr = instr.replace(',', '').split()

        def clean(x: str):
            try:
                return int(x)
            except ValueError:
                if x[0] == 'x' and x[1:].isdigit():
                    return self.sim.reg(x)
                else:
                    return x

        instr = tuple(clean(i) for i in instr)
        assert packed == instr