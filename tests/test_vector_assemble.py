import pytest

from modules.vector import Vector
from modules.csr import CSR
from modules.RV32I import RV32I
from riscv import RISCV
from test_commons import *

tests = [
    # TODO Loads, Stores
    ('vadd.vv v0, v1, v2',                  '00000010000100010000000001010111'),
    ('vsub.vv v31, v12, v9, v0.t',          '00001000110001001000111111010111'),
    ('vminu.vv v17, v18, v19, v0.t',        '00010001001010011000100011010111'),
    ('vmin.vv v1, v31, v20',                '00010111111110100000000011010111'),
    ('vmaxu.vv v5, v25, v15',               '00011011100101111000001011010111'),
    ('vmax.vv v6, v16, v26, v0.t',          '00011101000011010000001101010111'),
    ('vand.vv v9, v9, v9',                  '00100110100101001000010011010111'),
    ('vor.vv v30, v0, v30, v0.t',           '00101000000011110000111101010111'),
    ('vxor.vv v1, v3, v2, v0.t',            '00101100001100010000000011010111'),
    ('vrgather.vv v12, v21, v11, v0.t',     '00110001010101011000011001010111'),
    ('vrgatherei16.vv v9, v29, v15',        '00111011110101111000010011010111'),
    ('vadc.vvm v29, v11, v17',              '01000000101110001000111011010111'),
    ('vsbc.vvm v0, v1, v14',                '01001000000101110000000001010111'),
    ('vmerge.vvm v16, v26, v6',             '01011101101000110000100001010111'),
    ('vmv.v.v v0, v31',                     '01011110000011111000000001010111'),
    ('vmseq.vv v11, v29, v17, v0.t',        '01100001110110001000010111010111'),
    ('vmsne.vv v24, v29, v14, v0.t',        '01100101110101110000110001010111'),
    ('vmsltu.vv v25, v5, v0',               '01101010010100000000110011010111'),
    ('vmslt.vv v25, v3, v13',               '01101110001101101000110011010111'),
    ('vmsleu.vv v10, v18, v2',              '01110011001000010000010101010111'),
    ('vmsle.vv v15, v19, v26, v0.t',        '01110101001111010000011111010111'),
    ('vsaddu.vv v12, v20, v30, v0.t',       '10000001010011110000011001010111'),
    ('vsadd.vv v19, v13, v14',              '10000110110101110000100111010111'),
    ('vssubu.vv v22, v6, v8',               '10001010011001000000101101010111'),
    ('vssub.vv v26, v11, v6',               '10001110101100110000110101010111'),
    ('vsll.vv v19, v4, v9',                 '10010110010001001000100111010111'),
    ('vsmul.vv v10, v29, v22, v0.t',        '10011101110110110000010101010111'),
    ('vsrl.vv v27, v16, v29',               '10100011000011101000110111010111'),
    ('vsra.vv v2, v7, v5, v0.t',            '10100100011100101000000101010111'),
    ('vssrl.vv v23, v7, v30',               '10101010011111110000101111010111'),
    ('vssra.vv v22, v2, v11, v0.t',         '10101100001001011000101101010111'),
    ('vnsrl.wv v22, v31, v0, v0.t',         '10110001111100000000101101010111'),
    ('vnsra.wv v26, v11, v20, v0.t',        '10110100101110100000110101010111'),
    ('vnclipu.wv v29, v11, v30, v0.t',      '10111000101111110000111011010111'),
    ('vnclip.wv v18, v5, v16',              '10111110010110000000100101010111'),
    ('vwredsumu.vs v2, v16, v28',           '11000011000011100000000101010111'),
    ('vwredsum.vs v6, v12, v28',            '11000110110011100000001101010111'),
    # OPFVV
    ('vfadd.vv v14, v15, v19',              '00000010111110011001011101010111'),
    ('vfredusum.vs v30, v16, v18',          '00000111000010010001111101010111'),
    ('vfsub.vv v15, v19, v16, v0.t',        '00001001001110000001011111010111'),
    ('vfredosum.vs v20, v13, v25, v0.t',    '00001100110111001001101001010111'),
    ('vfmin.vv v16, v31, v2',               '00010011111100010001100001010111'),
    ('vfredmin.vs v14, v23, v4, v0.t',      '00010101011100100001011101010111'),
    ('vfmax.vv v12, v5, v27',               '00011010010111011001011001010111'),
    ('vfredmax.vs v17, v12, v22',           '00011110110010110001100011010111'),
    ('vfsgnj.vv v24, v20, v8, v0.t',        '00100001010001000001110001010111'),
    ('vfsgnjn.vv v13, v16, v26, v0.t',      '00100101000011010001011011010111'),
    ('vfsgnjx.vv v31, v3, v8',              '00101010001101000001111111010111'),
    ('vfmv.f.s f18, v27',                   '01000011101100000001100101010111'),
    ('vfcvt.xu.f.v v9, v13',                '01001010110100000001010011010111'),
    ('vfcvt.x.f.v v3, v12',                 '01001010110000001001000111010111'),
    ('vfcvt.f.xu.v v31, v13, v0.t',         '01001000110100010001111111010111'),
    ('vfcvt.f.x.v v14, v17',                '01001011000100011001011101010111'),
    ('vfcvt.rtz.xu.f.v v7, v11',            '01001010101100110001001111010111'),
    ('vfcvt.rtz.x.f.v v27, v19, v0.t',      '01001001001100111001110111010111'),
    ('vfwcvt.xu.f.v v17, v28, v0.t',        '01001001110001000001100011010111'),
    ('vfwcvt.x.f.v v18, v23',               '01001011011101001001100101010111'),
    ('vfwcvt.f.xu.v v19, v5, v0.t',         '01001000010101010001100111010111'),
    ('vfwcvt.f.x.v v21, v21',               '01001011010101011001101011010111'),
    ('vfwcvt.f.f.v v7, v17',                '01001011000101100001001111010111'),
    ('vfwcvt.rtz.xu.f.v v25, v18, v0.t',    '01001001001001110001110011010111'),
    ('vfwcvt.rtz.x.f.v v13, v27',           '01001011101101111001011011010111'),
    ('vfncvt.xu.f.w v5, v3',                '01001010001110000001001011010111'),
    ('vfncvt.x.f.w v17, v28',               '01001011110010001001100011010111'),
    ('vfncvt.f.xu.w v14, v29',              '01001011110110010001011101010111'),
    ('vfncvt.f.x.w v30, v21',               '01001011010110011001111101010111'),
    ('vfncvt.f.f.w v10, v3, v0.t',          '01001000001110100001010101010111'),
    ('vfncvt.rod.f.f.w v11, v25, v0.t',     '01001001100110101001010111010111'),
    ('vfncvt.rtz.xu.f.w v20, v6',           '01001010011010110001101001010111'),
    ('vfncvt.rtz.x.f.w v28, v11',           '01001010101110111001111001010111'),
    ('vfsqrt.v v15, v1, v0.t',              '01001100000100000001011111010111'),
    ('vfrsqrt7.v v18, v29',                 '01001111110100100001100101010111'),
    ('vfrec7.v v14, v28, v0.t',             '01001101110000101001011101010111'),
    ('vfclass.v v27, v3',                   '01001110001110000001110111010111'),
    ('vmfeq.vv v7, v23, v13',               '01100011011101101001001111010111'),
    ('vmfle.vv v20, v30, v10',              '01100111111001010001101001010111'),
    ('vmflt.vv v13, v4, v8, v0.t',          '01101100010001000001011011010111'),
    ('vmfne.vv v1, v28, v19, v0.t',         '01110001110010011001000011010111'),
    ('vfdiv.vv v10, v27, v11',              '10000011101101011001010101010111'),
    ('vfmul.vv v2, v1, v29',                '10010010000111101001000101010111'),
    ('vfmadd.vv v10, v6, v15, v0.t',        '10100000111100110001010101010111'),
    ('vfnmadd.vv v21, v18, v28, v0.t',      '10100101110010010001101011010111'),
    ('vfmsub.vv v22, v13, v5, v0.t',        '10101000010101101001101101010111'),
    ('vfnmsub.vv v6, v3, v7, v0.t',         '10101100011100011001001101010111'),
    ('vfmacc.vv v5, v10, v24',              '10110011100001010001001011010111'),
    ('vfnmacc.vv v12, v30, v5, v0.t',       '10110100010111110001011001010111'),
    ('vfmsac.vv v13, v26, v23, v0.t',       '10111001011111010001011011010111'),
    ('vfnmsac.vv v21, v3, v9, v0.t',        '10111100100100011001101011010111'),
    ('vfwadd.vv v20, v23, v29',             '11000011011111101001101001010111'),
    ('vfwredusum.vs v16, v15, v20',         '11000110111110100001100001010111'),
    ('vfwsub.vv v25, v3, v24',              '11001010001111000001110011010111'),
    ('vfwredosum.vs v30, v13, v11, v0.t',   '11001100110101011001111101010111'),
    ('vfwadd.wv v24, v25, v18',             '11010011100110010001110001010111'),
    ('vfwsub.wv v12, v10, v10',             '11011010101001010001011001010111'),
    ('vfwmul.vv v5, v19, v14, v0.t',        '11100001001101110001001011010111'),
    ('vfwmacc.vv v19, v2, v1',              '11110010000100010001100111010111'),
    ('vfwnmacc.vv v9, v17, v9, v0.t',       '11110100100110001001010011010111'),
    ('vfwmsac.vv v24, v12, v20, v0.t',      '11111001010001100001110001010111'),
    ('vfwnmsac.vv v2, v9, v26, v0.t',       '11111101101001001001000101010111'),
    # OPMVV
    ('vredsum.vs v12, v4, v5, v0.t',        '00000000010000101010011001010111'),
    ('vredand.vs v25, v2, v16',             '00000110001010000010110011010111'),
    ('vredor.vs v22, v19, v11',             '00001011001101011010101101010111'),
    ('vredxor.vs v4, v25, v6, v0.t',        '00001101100100110010001001010111'),
    ('vredminu.vs v20, v14, v24',           '00010010111011000010101001010111'),
    ('vredmin.vs v26, v11, v14, v0.t',      '00010100101101110010110101010111'),
    ('vredmaxu.vs v14, v23, v1',            '00011011011100001010011101010111'),
    ('vredmax.vs v18, v21, v11, v0.t',      '00011101010101011010100101010111'),
    ('vaaddu.vv v17, v1, v24, v0.t',        '00100000000111000010100011010111'),
    ('vaadd.vv v12, v17, v29, v0.t',        '00100101000111101010011001010111'),
    ('vasubu.vv v20, v17, v7',              '00101011000100111010101001010111'),
    ('vasub.vv v30, v11, v1, v0.t',         '00101100101100001010111101010111'),
    ('vmv.x.s x19, v10',                    '01000010101000000010100111010111'),
    ('vzext.vf8 v5, v16',                   '01001011000000010010001011010111'),
    ('vsext.vf8 v10, v24, v0.t',            '01001001100000011010010101010111'),
    ('vzext.vf4 v7, v19, v0.t',             '01001001001100100010001111010111'),
    ('vsext.vf4 v27, v9',                   '01001010100100101010110111010111'),
    ('vzext.vf2 v0, v16',                   '01001011000000110010000001010111'),
    ('vsext.vf2 v6, v8, v0.t',              '01001000100000111010001101010111'),
    ('vmsbf.m v20, v31, v0.t',              '01010001111100001010101001010111'),
    ('vmsof.m v3, v17',                     '01010011000100010010000111010111'),
    ('vmsif.m v18, v31, v0.t',              '01010001111100011010100101010111'),
    ('viota.m v26, v10, v0.t',              '01010000101010000010110101010111'),
    ('vid.v v0',                            '01010010000010001010000001010111'),
    ('vcompress.vm v2, v29, v6',            '01011111110100110010000101010111'),
    ('vmandn.mm v8, v26, v11',              '01100011101001011010010001010111'),
    ('vmand.mm v17, v27, v29',              '01100111101111101010100011010111'),
    ('vmor.mm v3, v25, v8',                 '01101011100101000010000111010111'),
    ('vmxor.mm v9, v21, v12',               '01101111010101100010010011010111'),
    ('vmorn.mm v11, v7, v5',                '01110010011100101010010111010111'),
    ('vmnand.mm v1, v23, v6',               '01110111011100110010000011010111'),
    ('vmnor.mm v6, v5, v1',                 '01111010010100001010001101010111'),
    ('vmxnor.mm v1, v31, v16',              '01111111111110000010000011010111'),
    ('vdivu.vv v18, v17, v29',              '10000011000111101010100101010111'),
    ('vdiv.vv v4, v8, v14',                 '10000110100001110010001001010111'),
    ('vremu.vv v26, v4, v1',                '10001010010000001010110101010111'),
    ('vrem.vv v25, v27, v12',               '10001111101101100010110011010111'),
    ('vmulhu.vv v8, v1, v6, v0.t',          '10010000000100110010010001010111'),
    ('vmul.vv v30, v4, v27',                '10010110010011011010111101010111'),
    ('vmulhsu.vv v14, v2, v28',             '10011010001011100010011101010111'),
    ('vmulh.vv v27, v24, v30',              '10011111100011110010110111010111'),
    ('vmadd.vv v2, v10, v22, v0.t',         '10100101011001010010000101010111'),
    ('vnmsub.vv v12, v30, v13',             '10101110110111110010011001010111'),
    ('vmacc.vv v0, v16, v29',               '10110111110110000010000001010111'),
    ('vnmsac.vv v26, v12, v5, v0.t',        '10111100010101100010110101010111'),
    ('vwaddu.vv v14, v25, v17, v0.t',       '11000001100110001010011101010111'),
    ('vwadd.vv v23, v26, v9, v0.t',         '11000101101001001010101111010111'),
    ('vwsubu.vv v19, v4, v2',               '11001010010000010010100111010111'),
    ('vwsub.vv v16, v20, v3',               '11001111010000011010100001010111'),
    ('vwaddu.wv v30, v24, v3',              '11010011100000011010111101010111'),
    ('vwadd.wv v9, v6, v15, v0.t',          '11010100011001111010010011010111'),
    ('vwsubu.wv v20, v1, v8',               '11011010000101000010101001010111'),
    ('vwsub.wv v20, v27, v21',              '11011111101110101010101001010111'),
    ('vwmulu.vv v0, v3, v12, v0.t',         '11100000001101100010000001010111'),
    ('vwmulsu.vv v18, v24, v14',            '11101011100001110010100101010111'),
    ('vwmul.vv v11, v20, v5',               '11101111010000101010010111010111'),
    ('vwmaccu.vv v5, v10, v24',             '11110011100001010010001011010111'),
    ('vwmacc.vv v19, v18, v22, v0.t',       '11110101011010010010100111010111'),
    ('vwmaccsu.vv v12, v7, v17',            '11111111000100111010011001010111'),
    # OPIVI
    ('vadd.vi v18, v21, 15',                '00000011010101111011100101010111'),
    ('vrsub.vi v7, v1, -16',                '00001110000110000011001111010111'),
    ('vand.vi v23, v5, 0',                  '00100110010100000011101111010111'),
    ('vor.vi v15, v13, 11, v0.t',           '00101000110101011011011111010111'),
    ('vxor.vi v3, v10, -3, v0.t',           '00101100101011101011000111010111'),
    ('vrgather.vi v1, v0, 8',               '00110010000001000011000011010111'),
    ('vslideup.vi v23, v7, 2, v0.t',        '00111000011100010011101111010111'),
    ('vslidedown.vi, v28, v29, 3, v0.t',    '00111101110100011011111001010111'),
    ('vadc.vim v10, v8, 6',                 '01000000100000110011010101010111'),
    ('vmerge.vim v3, v9, -1',               '01011100100111111011000111010111'),
    ('vmv.v.i v3, 12',                      '01011110000001100011000111010111'),
    ('vmseq.vi v10, v12, -7, v0.t',         '01100000110011001011010101010111'),
    ('vmsne.vi v13, v19, -15',              '01100111001110001011011011010111'),
    ('vmsleu.vi v10, v13, 2, v0.t',         '01110000110100010011010101010111'),
    ('vmsle.vi v25, v12, 9',                '01110110110001001011110011010111'),
    ('vmsgtu.vi v24, v6, 4',                '01111010011000100011110001010111'),
    ('vmsgt.vi v13, v8, -7',                '01111110100011001011011011010111'),
    ('vsaddu.vi v26, v23, 11',              '10000011011101011011110101010111'),
    ('vsadd.vi v1, v21, -10, v0.t',         '10000101010110110011000011010111'),
    ('vmv1r.v v25, v5',                     '10011110010100000011110011010111'),
    ('vmv2r.v v10, v4',                     '10011110010000001011010101010111'),
    ('vmv4r.v v19, v29',                    '10011111110100011011100111010111'),
    ('vmv8r.v, v11, v24',                   '10011111100000111011010111010111'),
    ('vsrl.vi v3, v10, 8',                  '10100010101001000011000111010111'),
    ('vsra.vi v22, v4, 15',                 '10100110010001111011101101010111'),
    ('vssrl.vi v22, v23, 11, v0.t',         '10101001011101011011101101010111'),
    ('vssra.vi v10, v31, 2',                '10101111111100010011010101010111'),
    ('vnsrl.wi v6, v26, 15, v0.t',          '10110001101001111011001101010111'),
    ('vnsra.wi v22, v20, 12, v0.t',         '10110101010001100011101101010111'),
    ('vnclipu.wi v5, v26, 4, v0.t',         '10111001101000100011001011010111'),
    ('vnclip.wi v16, v28, 13, v0.t',        '10111101110001101011100001010111'),
    #OPIVX
    ('vadd.vx v24, v26, x31',               '00000011101011111100110001010111'),
    ('vsub.vx v1, v13, x15, v0.t',          '00001000110101111100000011010111'),
    ('vrsub.vx v11, v5, x13, v0.t',         '00001100010101101100010111010111'),
    ('vminu.vx v12, v27, x0, v0.t',         '00010001101100000100011001010111'),
    ('vmin.vx v4, v18, x16, v0.t',          '00010101001010000100001001010111'),
    ('vmaxu.vx v1, v6, x15, v0.t',          '00011000011001111100000011010111'),
    ('vmax.vx v15, v26, x5',                '00011111101000101100011111010111'),
    ('vand.vx v2, v5, x4',                  '00100110010100100100000101010111'),
    ('vor.vx v13, v28, x20',                '00101011110010100100011011010111'),
    ('vxor.vx v7, v31, x23',                '00101111111110111100001111010111'),
    ('vrgather.vx v12, v13, x17, v0.t',     '00110000110110001100011001010111'),
    ('vslideup.vx v25, v2, x13',            '00111010001001101100110011010111'),
    ('vslidedown.vx v27, v21, x14, v0.t',   '00111101010101110100110111010111'),
    ('vadc.vxm v5, v19, x21',               '01000001001110101100001011010111'),
    ('vmadc.vxm v22, v20, x2',              '01000101010000010100101101010111'),
    ('vsbc.vxm v16, v20, x6',               '01001001010000110100100001010111'),
    ('vmsbc.vxm v26, v9, x13',              '01001100100101101100110101010111'),
    ('vmerge.vxm v12, v8, x25',             '01011100100011001100011001010111'),
    ('vmv.v.x v28, x8',                     '01011110000001000100111001010111'),
    ('vmseq.vx v6, v5, x27',                '01100010010111011100001101010111'),
    ('vmsne.vx v17, v16, x3',               '01100111000000011100100011010111'),
    ('vmsltu.vx v26, v12, x11',             '01101010110001011100110101010111'),
    ('vmslt.vx v29, v25, x4, v0.t',         '01101101100100100100111011010111'),
    ('vmsleu.vx v8, v16, x22',              '01110011000010110100010001010111'),
    ('vmsle.vx v16, v4, x2, v0.t',          '01110100010000010100100001010111'),
    ('vmsgtu.vx v24, v25, x27, v0.t',       '01111001100111011100110001010111'),
    ('vmsgt.vx v0, v30, x8',                '01111111111001000100000001010111'),
    ('vsaddu.vx v19, v15, x23',             '10000010111110111100100111010111'),
    ('vsadd.vx v9, v24, x23',               '10000111100010111100010011010111'),
    ('vssubu.vx v7, v2, x10',               '10001010001001010100001111010111'),
    ('vssub.vx v13, v3, x9, v0.t',          '10001100001101001100011011010111'),
    ('vsll.vx v7, v31, x4, v0.t',           '10010101111100100100001111010111'),
    ('vsmul.vx v4, v11, x5',                '10011110101100101100001001010111'),
    ('vsrl.vx v6, v19, x3',                 '10100011001100011100001101010111'),
    ('vsra.vx v14, v13, x20, v0.t',         '10100100110110100100011101010111'),
    ('vssrl.vx v20, v21, x9',               '10101011010101001100101001010111'),
    ('vssra.vx v19, v18, x2',               '10101111001000010100100111010111'),
    ('vnsrl.wx, v18, v17, x1',              '10110011000100001100100101010111'),
    ('vnsra.wx v11, v15, x27, v0.t',        '10110100111111011100010111010111'),
    ('vnclipu.wx v9, v26, x0, v0.t',        '10111001101000000100010011010111'),
    ('vnclip.wx v21, v26, x6',              '10111111101000110100101011010111'),
    # TODO OPFVF
    # OPMVX
    ('vaaddu.vx v8, v31, x23',              '00100011111110111110010001010111'),
    ('vaadd.vx v2, v6, x11',                '00100110011001011110000101010111'),
    ('vasubu.vx v31, v0, x21',              '00101010000010101110111111010111'),
    ('vasub.vx v28, v24, x29, v0.t',        '00101101100011101110111001010111'),
    ('vslide1up.vx v27, v30, x22, v0.t',    '00111001111010110110110111010111'),
    ('vslide1down.vx v26, v0, x27',         '00111110000011011110110101010111'),
    ('vmv.s.x v18, x7',                     '01000010000000111110100101010111'),
    ('vdivu.vx v2, v29, x14',               '10000011110101110110000101010111'),
    ('vdiv.vx v31, v15, x28',               '10000110111111100110111111010111'),
    ('vremu.vx v13, v25, x16',              '10001011100110000110011011010111'),
    ('vrem.vx v25, v8, x2',                 '10001110100000010110110011010111'),
    ('vmulhu.vx v0, v19, x26, v0.t',        '10010001001111010110000001010111'),
    ('vmulh.vx v28, v9, x12',               '10011110100101100110111001010111'),
    ('vmadd.vx v2, x9, v20',                '10100111010001001110000101010111'),
    ('vnmsub.vx v17, x8, v28, v0.t',        '10101101110001000110100011010111'),
    ('vmacc.vx v22, x24, v11, v0.t',        '10110100101111000110101101010111'),
    ('vnmsac.vx v18, x1, v28, v0.t',        '10111101110000001110100101010111'),
    ('vwaddu.vx v7, v0, x1, v0.t',          '11000000000000001110001111010111'),
    ('vwadd.vx v22, v1, x10',               '11000110000101010110101101010111'),
    ('vwsubu.vx v15, v1, x9',               '11001010000101001110011111010111'),
    ('vwsub.vx v27, v31, x13',              '11001111111101101110110111010111'),
    ('vwaddu.wx v1, v11, x25',              '11010010101111001110000011010111'),
    ('vwadd.wx v30, v27, x4',               '11010111101100100110111101010111'),
    ('vwsubu.wx v11, v17, x7, v0.t',        '11011001000100111110010111010111'),
    ('vwsub.wx v17, v13, x9, v0.t',         '11011100110101001110100011010111'),
    ('vwmulu.vx v13, v12, x19',             '11100010110010011110011011010111'),
    ('vwmulsu.vx v20, v28, x12, v0.t',      '11101001110001100110101001010111'),
    ('vwmul.vx v14, v22, x30, v0.t',        '11101101011011110110011101010111'),
    ('vwmaccu.vx v11, x14, v20, v0.t',      '11110001010001110110010111010111'),
    ('vwmacc.vx v24, x20, v10, v0.t',       '11110100101010100110110001010111'),
    ('vwmaccus.vx v11, x20, v28, v0.t',     '11111001110010100110010111010111'),
    ('vwmaccsu.vx v27, x7, v0',             '11111110000000111110110111010111')
    # TO fix: OPIVI signed vs unsigned arg
]

sim = RISCV([RV32I, CSR, Vector], 16, [], debug=True)
mod = sim.modules['Vector']


@pytest.mark.parametrize('instr, binary', tests)

def test_assemble(instr, binary):
    tcom_assemble(sim, mod, instr, binary)
@pytest.mark.parametrize('instr, binary', tests)


def test_unassemble(instr, binary):
    tcom_unassemble(mod, instr, binary)