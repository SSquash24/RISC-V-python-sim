import pytest

from modules.vector import Vector
from modules.csr import CSR
from modules.RV32I import RV32I
from riscv import RISCV
from test_commons import *

tests = [
    # TODO Loads, Stores
    ('vadd.vv v0, v1, v2',                  '00000010000100010000000001010111'),
    ('vsub.vv v31, v12, v9, v0.t',          '00001000110001001000111111010111'),
    ('vminu.vv v17, v18, v19, v0.t',        '00010001001010011000100011010111'),
    ('vmin.vv v1, v31, v20',                '00010111111110100000000011010111'),
    ('vmaxu.vv v5, v25, v15',               '00011011100101111000001011010111'),
    ('vmax.vv v6, v16, v26, v0.t',          '00011101000011010000001101010111'),
    ('vand.vv v9, v9, v9',                  '00100110100101001000010011010111'),
    ('vor.vv v30, v0, v30, v0.t',           '00101000000011110000111101010111'),
    ('vxor.vv v1, v3, v2, v0.t',            '00101100001100010000000011010111'),
    ('vrgather.vv v12, v21, v11, v0.t',     '00110001010101011000011001010111'),
    ('vrgatherei16.vv v9, v29, v15',        '00111011110101111000010011010111'),
    ('vadc.vvm v29, v11, v17',              '01000000101110001000111011010111'),
    ('vsbc.vvm v0, v1, v14',                '01001000000101110000000001010111'),
    ('vmerge.vvm v16, v26, v6',             '01011101101000110000100001010111'),
    ('vmv.v.v v0, v31',                     '01011110000011111000000001010111'),
    ('vmseq.vv v11, v29, v17, v0.t',        '01100001110110001000010111010111'),
    ('vmsne.vv v24, v29, v14, v0.t',        '01100101110101110000110001010111'),
    ('vmsltu.vv v25, v5, v0',               '01101010010100000000110011010111'),
    ('vmslt.vv v25, v3, v13',               '01101110001101101000110011010111'),
    ('vmsleu.vv v10, v18, v2',              '01110011001000010000010101010111'),
    ('vmsle.vv v15, v19, v26, v0.t',        '01110101001111010000011111010111'),
    ('vsaddu.vv v12, v20, v30, v0.t',       '10000001010011110000011001010111'),
    ('vsadd.vv v19, v13, v14',              '10000110110101110000100111010111'),
    ('vssubu.vv v22, v6, v8',               '10001010011001000000101101010111'),
    ('vssub.vv v26, v11, v6',               '10001110101100110000110101010111'),
    ('vsll.vv v19, v4, v9',                 '10010110010001001000100111010111'),
    ('vsmul.vv v10, v29, v22, v0.t',        '10011101110110110000010101010111'),
    ('vsrl.vv v27, v16, v29',               '10100011000011101000110111010111'),
    ('vsra.vv v2, v7, v5, v0.t',            '10100100011100101000000101010111'),
    ('vssrl.vv v23, v7, v30',               '10101010011111110000101111010111'),
    ('vssra.vv v22, v2, v11, v0.t',         '10101100001001011000101101010111'),
    ('vnsrl.wv v22, v31, v0, v0.t',         '10110001111100000000101101010111'),
    ('vnsra.wv v26, v11, v20, v0.t',        '10110100101110100000110101010111'),
    ('vnclipu.wv v29, v11, v30, v0.t',      '10111000101111110000111011010111'),
    ('vnclip.wv v18, v5, v16',              '10111110010110000000100101010111'),
    ('vwredsumu.vs v2, v16, v28',           '11000011000011100000000101010111'),
    ('vwredsum.vs v6, v12, v28',            '11000110110011100000001101010111'),
    # TODO OPFVV
    # OPMVV
    ('vredsum.vs v12, v4, v5, v0.t',        '00000000010000101010011001010111'),
    ('vredand.vs v25, v2, v16',             '00000110001010000010110011010111'),
    ('vredor.vs v22, v19, v11',             '00001011001101011010101101010111'),
    ('vredxor.vs v4, v25, v6, v0.t',        '00001101100100110010001001010111'),
    ('vredminu.vs v20, v14, v24',           '00010010111011000010101001010111'),
    ('vredmin.vs v26, v11, v14, v0.t',      '00010100101101110010110101010111'),
    ('vredmaxu.vs v14, v23, v1',            '00011011011100001010011101010111'),
    ('vredmax.vs v18, v21, v11, v0.t',      '00011101010101011010100101010111'),
    ('vaaddu.vv v17, v1, v24, v0.t',        '00100000000111000010100011010111'),
    ('vaadd.vv v12, v17, v29, v0.t',        '00100101000111101010011001010111'),
    ('vasubu.vv v20, v17, v7',              '00101011000100111010101001010111'),
    ('vasub.vv v30, v11, v1, v0.t',         '00101100101100001010111101010111'),
    ('vmv.x.s x19, v10',                    '01000010101000000010100111010111'),
    ('vzext.vf8 v5, v16',                   '01001011000000010010001011010111'),
    ('vsext.vf8 v10, v24, v0.t',            '01001001100000011010010101010111'),
    ('vzext.vf4 v7, v19, v0.t',             '01001001001100100010001111010111'),
    ('vsext.vf4 v27, v9',                   '01001010100100101010110111010111'),
    ('vzext.vf2 v0, v16',                   '01001011000000110010000001010111'),
    ('vsext.vf2 v6, v8, v0.t',              '01001000100000111010001101010111'),
    ('vmsbf.m v20, v31, v0.t',              '01010001111100001010101001010111'),
    ('vmsof.m v3, v17',                     '01010011000100010010000111010111'),
    ('vmsif.m v18, v31, v0.t',              '01010001111100011010100101010111'),
    ('viota.m v26, v10, v0.t',              '01010000101010000010110101010111'),
    ('vid.v v0',                            '01010010000010001010000001010111'),
    ('vcompress.vm v2, v29, v6',            '01011111110100110010000101010111'),
    ('vmandn.mm v8, v26, v11',              '01100011101001011010010001010111'),
    ('vmand.mm v17, v27, v29',              '01100111101111101010100011010111'),
    ('vmor.mm v3, v25, v8',                 '01101011100101000010000111010111'),
    ('vmxor.mm v9, v21, v12',               '01101111010101100010010011010111'),
    ('vmorn.mm v11, v7, v5',                '01110010011100101010010111010111'),
    ('vmnand.mm v1, v23, v6',               '01110111011100110010000011010111'),
    ('vmnor.mm v6, v5, v1',                 '01111010010100001010001101010111'),
    ('vmxnor.mm v1, v31, v16',              '01111111111110000010000011010111'),
    ('vdivu.vv v18, v17, v29',              '10000011000111101010100101010111'),
    ('vdiv.vv v4, v8, v14',                 '10000110100001110010001001010111'),
    ('vremu.vv v26, v4, v1',                '10001010010000001010110101010111'),
    ('vrem.vv v25, v27, v12',               '10001111101101100010110011010111'),
    ('vmulhu.vv v8, v1, v6, v0.t',          '10010000000100110010010001010111'),
    ('vmul.vv v30, v4, v27',                '10010110010011011010111101010111'),
    ('vmulhsu.vv v14, v2, v28',             '10011010001011100010011101010111'),
    ('vmulh.vv v27, v24, v30',              '10011111100011110010110111010111'),
    ('vmadd.vv v2, v10, v22, v0.t',         '10100101011001010010000101010111'),
    ('vnmsub.vv v12, v30, v13',             '10101110110111110010011001010111'),
    ('vmacc.vv v0, v16, v29',               '10110111110110000010000001010111'),
    ('vnmsac.vv v26, v12, v5, v0.t',        '10111100010101100010110101010111'),
    ('vwaddu.vv v14, v25, v17, v0.t',       '11000001100110001010011101010111'),
    ('vwadd.vv v23, v26, v9, v0.t',         '11000101101001001010101111010111'),
    ('vwsubu.vv v19, v4, v2',               '11001010010000010010100111010111'),
    ('vwsub.vv v16, v20, v3',               '11001111010000011010100001010111'),
    ('vwaddu.wv v30, v24, v3',              '11010011100000011010111101010111'),
    ('vwadd.wv v9, v6, v15, v0.t',          '11010100011001111010010011010111'),
    ('vwsubu.wv v20, v1, v8',               '11011010000101000010101001010111'),
    ('vwsub.wv v20, v27, v21',              '11011111101110101010101001010111'),
    ('vwmulu.vv v0, v3, v12, v0.t',         '11100000001101100010000001010111'),
    ('vwmulsu.vv v18, v24, v14',            '11101011100001110010100101010111'),
    ('vwmul.vv v11, v20, v5',               '11101111010000101010010111010111'),
    ('vwmaccu.vv v5, v10, v24',             '11110011100001010010001011010111'),
    ('vwmacc.vv v19, v18, v22, v0.t',       '11110101011010010010100111010111'),
    ('vwmaccsu.vv v12, v7, v17',            '11111111000100111010011001010111'),
    # OPIVI
    ('vadd.vi v18, v21, 15',                '00000011010101111011100101010111'),
    ('vrsub.vi v7, v1, -16',                '00001110000110000011001111010111'),
    ('vand.vi v23, v5, 0',                  '00100110010100000011101111010111'),
    ('vor.vi v15, v13, 11, v0.t',           '00101000110101011011011111010111'),
    ('vxor.vi v3, v10, -3, v0.t',           '00101100101011101011000111010111'),
    ('vrgather.vi v1, v0, 8',               '00110010000001000011000011010111'),
    ('vslideup.vi v23, v7, 2, v0.t',        '00111000011100010011101111010111'),
    ('vslidedown.vi, v28, v29, 3, v0.t',    '00111101110100011011111001010111'),
    ('vadc.vim v10, v8, 6',                 '01000000100000110011010101010111'),
    ('vmerge.vim v3, v9, -1',               '01011100100111111011000111010111'),
    ('vmv.v.i v3, 12',                      '01011110000001100011000111010111'),
    ('vmseq.vi v10, v12, -7, v0.t',         '01100000110011001011010101010111'),
    ('vmsne.vi v13, v19, -15',              '01100111001110001011011011010111'),
    ('vmsleu.vi v10, v13, 2, v0.t',         '01110000110100010011010101010111'),
    ('vmsle.vi v25, v12, 9',                '01110110110001001011110011010111'),
    ('vmsgtu.vi v24, v6, 4',                '01111010011000100011110001010111'),
    ('vmsgt.vi v13, v8, -7',                '01111110100011001011011011010111'),
    ('vsaddu.vi v26, v23, 11',              '10000011011101011011110101010111'),
    ('vsadd.vi v1, v21, -10, v0.t',         '10000101010110110011000011010111'),
    ('vmv1r.v v25, v5',                     '10011110010100000011110011010111'),
    ('vmv2r.v v10, v4',                     '10011110010000001011010101010111'),
    ('vmv4r.v v19, v29',                    '10011111110100011011100111010111'),
    ('vmv8r.v, v11, v24',                   '10011111100000111011010111010111'),
    ('vsrl.vi v3, v10, 8',                  '10100010101001000011000111010111'),
    ('vsra.vi v22, v4, 15',                 '10100110010001111011101101010111'),
    ('vssrl.vi v22, v23, 11, v0.t',         '10101001011101011011101101010111'),
    ('vssra.vi v10, v31, 2',                '10101111111100010011010101010111'),
    ('vnsrl.wi v6, v26, 15, v0.t',          '10110001101001111011001101010111'),
    ('vnsra.wi v22, v20, 12, v0.t',         '10110101010001100011101101010111'),
    ('vnclipu.wi v5, v26, 4, v0.t',         '10111001101000100011001011010111'),
    ('vnclip.wi v16, v28, 13, v0.t',        '10111101110001101011100001010111'),
    #OPIVX
    ('vadd.vx v24, v26, x31',               '00000011101011111100110001010111'),
    ('vsub.vx v1, v13, x15, v0.t',          '00001000110101111100000011010111'),
    ('vrsub.vx v11, v5, x13, v0.t',         '00001100010101101100010111010111'),
    ('vminu.vx v12, v27, x0, v0.t',         '00010001101100000100011001010111'),
    ('vmin.vx v4, v18, x16, v0.t',          '00010101001010000100001001010111'),
    ('vmaxu.vx v1, v6, x15, v0.t',          '00011000011001111100000011010111'),
    ('vmax.vx v15, v26, x5',                '00011111101000101100011111010111'),
    ('vand.vx v2, v5, x4',                  '00100110010100100100000101010111'),
    ('vor.vx v13, v28, x20',                '00101011110010100100011011010111'),
    ('vxor.vx v7, v31, x23',                '00101111111110111100001111010111'),
    ('vrgather.vx v12, v13, x17, v0.t',     '00110000110110001100011001010111'),
    ('vslideup.vx v25, v2, x13',            '00111010001001101100110011010111'),
    ('vslidedown.vx v27, v21, x14, v0.t',   '00111101010101110100110111010111'),
    ('vadc.vxm v5, v19, x21',               '01000001001110101100001011010111'),
    ('vmadc.vxm v22, v20, x2',              '01000101010000010100101101010111'),
    ('vsbc.vxm v16, v20, x6',               '01001001010000110100100001010111'),
    ('vmsbc.vxm v26, v9, x13',              '01001100100101101100110101010111'),
    ('vmerge.vxm v12, v8, x25',             '01011100100011001100011001010111'),
    ('vmv.v.x v28, x8',                     '01011110000001000100111001010111'),
    ('vmseq.vx v6, v5, x27',                '01100010010111011100001101010111'),
    ('vmsne.vx v17, v16, x3',               '01100111000000011100100011010111'),
    ('vmsltu.vx v26, v12, x11',             '01101010110001011100110101010111'),
    ('vmslt.vx v29, v25, x4, v0.t',         '01101101100100100100111011010111'),
    ('vmsleu.vx v8, v16, x22',              '01110011000010110100010001010111'),
    ('vmsle.vx v16, v4, x2, v0.t',          '01110100010000010100100001010111'),
    ('vmsgtu.vx v24, v25, x27, v0.t',       '01111001100111011100110001010111'),
    ('vmsgt.vx v0, v30, x8',                '01111111111001000100000001010111'),
    ('vsaddu.vx v19, v15, x23',             '10000010111110111100100111010111'),
    ('vsadd.vx v9, v24, x23',               '10000111100010111100010011010111'),
    ('vssubu.vx v7, v2, x10',               '10001010001001010100001111010111'),
    ('vssub.vx v13, v3, x9, v0.t',          '10001100001101001100011011010111'),
    ('vsll.vx v7, v31, x4, v0.t',           '10010101111100100100001111010111'),
    ('vsmul.vx v4, v11, x5',                '10011110101100101100001001010111'),
    ('vsrl.vx v6, v19, x3',                 '10100011001100011100001101010111'),
    ('vsra.vx v14, v13, x20, v0.t',         '10100100110110100100011101010111'),
    ('vssrl.vx v20, v21, x9',               '10101011010101001100101001010111'),
    ('vssra.vx v19, v18, x2',               '10101111001000010100100111010111'),
    ('vnsrl.wx, v18, v17, x1',              '10110011000100001100100101010111'),
    ('vnsra.wx v11, v15, x27, v0.t',        '10110100111111011100010111010111'),
    ('vnclipu.wx v9, v26, x0, v0.t',        '10111001101000000100010011010111'),
    ('vnclip.wx v21, v26, x6',              '10111111101000110100101011010111'),

    # TODO all but OPMVX, OPF__
    # TO fix: OPIVI signed vs unsigned arg
]

sim = RISCV([RV32I, CSR, Vector], 16, [], debug=True)
mod = sim.modules['Vector']


@pytest.mark.parametrize('instr, binary', tests)

def test_assemble(instr, binary):
    tcom_assemble(sim, mod, instr, binary)
@pytest.mark.parametrize('instr, binary', tests)


def test_unassemble(instr, binary):
    tcom_unassemble(mod, instr, binary)